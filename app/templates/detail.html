<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Number Detail</title>
	<link rel="stylesheet" href="/static/styles.css">
</head>
<body>
	<main class="container">
		<h1>Number Detail</h1>
		<div class="card">
			<h2 id="num"></h2>
			<p>Description: <span id="desc">-</span></p>
			<p>Carrier: <span id="carrier">-</span> | Line: <span id="line">-</span> | Type: <span id="type">-</span></p>
			<p>Timezones: <span id="tz">-</span></p>
			<p>Formats: <span id="fmt-e164"></span> · <span id="fmt-intl"></span> · <span id="fmt-national"></span></p>
			<p>Risk score: <strong id="risk">0</strong>/100</p>
		</div>
		<section>
			<h3>Reports</h3>
			<p>Approved total: <span id="rep-total">0</span></p>
			<ul id="rep-stats"></ul>
			<ul id="reports"></ul>
		</section>
		<section>
			<h3>Submit a report</h3>
			<form id="report-form">
				<label>Category
					<select id="category">
						<option value="spam">spam</option>
						<option value="fraud">fraud</option>
						<option value="scam">scam</option>
						<option value="harassment">harassment</option>
						<option value="other">other</option>
					</select>
				</label>
				<label>Confidence (0-100)
					<input type="number" id="confidence" min="0" max="100" value="50">
				</label>
				<label>Note
					<textarea id="note" maxlength="1000"></textarea>
				</label>
				<button type="submit">Submit</button>
				<p id="msg"></p>
			</form>
		</section>
	</main>
	<script>
	const e164 = decodeURIComponent(window.location.pathname.split('/').pop());
	document.getElementById('num').innerText = e164;

	async function loadDetails() {
		const res = await fetch(`/api/numbers/${encodeURIComponent(e164)}`);
		if (!res.ok) return;
		const data = await res.json();
		document.getElementById('carrier').innerText = data.carrier || '-';
		document.getElementById('line').innerText = data.line_type || '-';
		document.getElementById('type').innerText = data.number_type || '-';
		document.getElementById('tz').innerText = (data.timezones || []).join(', ') || '-';
		document.getElementById('desc').innerText = data.description || '-';
		document.getElementById('fmt-e164').innerText = data.formats.e164;
		document.getElementById('fmt-intl').innerText = data.formats.international;
		document.getElementById('fmt-national').innerText = data.formats.national;
		document.getElementById('risk').innerText = data.risk_score;
		document.getElementById('rep-total').innerText = data.report_stats.total_approved;
		const stats = document.getElementById('rep-stats');
		stats.innerHTML = '';
		Object.entries(data.report_stats.by_category || {}).forEach(([k,v]) => {
			const li = document.createElement('li');
			li.textContent = `${k}: ${v}`;
			stats.appendChild(li);
		});
		const list = document.getElementById('reports');
		list.innerHTML = '';
		(data.reports || []).forEach(r => {
			const li = document.createElement('li');
			li.textContent = `${r.category} (${r.confidence}): ${r.note || ''}`;
			list.appendChild(li);
		});
	}

	loadDetails();

	document.getElementById('report-form').addEventListener('submit', async (e) => {
		e.preventDefault();
		const payload = {
			category: document.getElementById('category').value,
			confidence: parseInt(document.getElementById('confidence').value, 10),
			note: document.getElementById('note').value || null,
		};
		const res = await fetch(`/api/numbers/${encodeURIComponent(e164)}/reports`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(payload),
		});
		const msg = document.getElementById('msg');
		if (!res.ok) {
			msg.textContent = 'Failed to submit report';
			return;
		}
		msg.textContent = 'Report submitted; pending approval.';
		loadDetails();
	});
	</script>
</body>
</html>